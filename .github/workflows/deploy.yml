name: Deploy

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - staging
          - production
      deployment_strategy:
        description: 'Deployment strategy'
        required: true
        type: choice
        options:
          - direct
          - blue-green
          - canary
      release_tag:
        description: 'Release tag to deploy'
        required: true
        type: string

env:
  DOTNET_VERSION: '8.0.x'
  BUILD_CONFIGURATION: 'Release'
  BUILD_PLATFORM: 'x64'

jobs:
  validate-release:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      is_prerelease: ${{ steps.check.outputs.is_prerelease }}
      version: ${{ steps.version.outputs.version }}
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        ref: ${{ inputs.release_tag || github.ref }}
        fetch-depth: 0
        
    - name: Check release type
      id: check
      run: |
        if [ "${{ github.event_name }}" == "release" ]; then
          echo "is_prerelease=${{ github.event.release.prerelease }}" >> $GITHUB_OUTPUT
        else
          echo "is_prerelease=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Extract version
      id: version
      run: |
        if [ "${{ github.event_name }}" == "release" ]; then
          VERSION="${{ github.event.release.tag_name }}"
        else
          VERSION="${{ inputs.release_tag }}"
        fi
        # Remove 'v' prefix if present
        VERSION="${VERSION#v}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Deploying version: $VERSION"
        
  build-release:
    name: Build Release
    runs-on: windows-latest
    needs: validate-release
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        ref: ${{ inputs.release_tag || github.ref }}
        fetch-depth: 0
        
    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
        
    - name: Restore dependencies
      working-directory: src
      run: dotnet restore --verbosity minimal
      
    - name: Build solution
      working-directory: src
      run: |
        dotnet clean UniGetUI.sln --verbosity minimal --nologo
        dotnet publish UniGetUI/UniGetUI.csproj `
          /noLogo `
          /property:Configuration=${{ env.BUILD_CONFIGURATION }} `
          /property:Platform=${{ env.BUILD_PLATFORM }} `
          --verbosity minimal
          
    - name: Generate integrity tree
      run: |
        python scripts/generate_integrity_tree.py src/UniGetUI/bin/${{ env.BUILD_PLATFORM }}/${{ env.BUILD_CONFIGURATION }}/net8.0-windows10.0.26100.0/win-x64/publish
        
    - name: Create deployment package
      run: |
        New-Item -Path "deploy" -ItemType Directory -Force
        Compress-Archive -Path "src/UniGetUI/bin/${{ env.BUILD_PLATFORM }}/${{ env.BUILD_CONFIGURATION }}/net8.0-windows10.0.26100.0/win-x64/publish/*" `
          -DestinationPath "deploy/UniGetUI-${{ needs.validate-release.outputs.version }}.zip"
          
    - name: Calculate checksums
      run: |
        $hash = (Get-FileHash "deploy/UniGetUI-${{ needs.validate-release.outputs.version }}.zip" -Algorithm SHA256).Hash
        echo "SHA256: $hash" | Out-File -FilePath "deploy/checksums.txt"
        
    - name: Upload deployment artifacts
      uses: actions/upload-artifact@v4
      with:
        name: deployment-package-${{ needs.validate-release.outputs.version }}
        path: deploy/
        retention-days: 90
        
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [validate-release, build-release]
    if: inputs.environment == 'staging' || needs.validate-release.outputs.is_prerelease == 'true'
    environment:
      name: staging
      url: https://staging.example.com
      
    steps:
    - name: Download deployment artifacts
      uses: actions/download-artifact@v4
      with:
        name: deployment-package-${{ needs.validate-release.outputs.version }}
        path: ./deploy
        
    - name: Deploy to staging environment
      run: |
        echo "Deploying version ${{ needs.validate-release.outputs.version }} to staging"
        echo "Deployment strategy: ${{ inputs.deployment_strategy || 'direct' }}"
        # Add actual deployment commands here
        
    - name: Run smoke tests
      run: |
        echo "Running smoke tests on staging environment"
        # Add smoke test commands here
        
    - name: Generate deployment report
      run: |
        cat > deployment-report.md << EOF
        # Staging Deployment Report
        
        - **Version:** ${{ needs.validate-release.outputs.version }}
        - **Environment:** Staging
        - **Strategy:** ${{ inputs.deployment_strategy || 'direct' }}
        - **Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        - **Status:** Success âœ…
        EOF
        
    - name: Upload deployment report
      uses: actions/upload-artifact@v4
      with:
        name: staging-deployment-report
        path: deployment-report.md
        
  deploy-production-direct:
    name: Deploy to Production (Direct)
    runs-on: ubuntu-latest
    needs: [validate-release, build-release]
    if: |
      (inputs.environment == 'production' && inputs.deployment_strategy == 'direct') ||
      (github.event_name == 'release' && needs.validate-release.outputs.is_prerelease == 'false' && inputs.deployment_strategy != 'blue-green' && inputs.deployment_strategy != 'canary')
    environment:
      name: production
      url: https://github.com/marticliment/UniGetUI/releases
      
    steps:
    - name: Download deployment artifacts
      uses: actions/download-artifact@v4
      with:
        name: deployment-package-${{ needs.validate-release.outputs.version }}
        path: ./deploy
        
    - name: Deploy to production
      run: |
        echo "Deploying version ${{ needs.validate-release.outputs.version }} to production"
        echo "Using direct deployment strategy"
        # Actual deployment is handled by existing winget-stable.yml workflow
        
    - name: Create deployment marker
      run: |
        echo "${{ needs.validate-release.outputs.version }}" > production-version.txt
        
    - name: Upload version marker
      uses: actions/upload-artifact@v4
      with:
        name: production-version-marker
        path: production-version.txt
        
  deploy-production-blue-green:
    name: Deploy to Production (Blue-Green)
    runs-on: ubuntu-latest
    needs: [validate-release, build-release]
    if: inputs.environment == 'production' && inputs.deployment_strategy == 'blue-green'
    environment:
      name: production
      url: https://github.com/marticliment/UniGetUI/releases
      
    steps:
    - name: Download deployment artifacts
      uses: actions/download-artifact@v4
      with:
        name: deployment-package-${{ needs.validate-release.outputs.version }}
        path: ./deploy
        
    - name: Deploy to green environment
      run: |
        echo "Step 1: Deploying to GREEN environment"
        echo "Version: ${{ needs.validate-release.outputs.version }}"
        # Deploy to green environment (inactive)
        
    - name: Run health checks on green
      run: |
        echo "Step 2: Running health checks on GREEN environment"
        # Add health check commands
        sleep 5  # Simulate health check
        echo "âœ… Green environment is healthy"
        
    - name: Switch traffic to green
      run: |
        echo "Step 3: Switching traffic from BLUE to GREEN"
        # Switch load balancer or DNS to point to green environment
        echo "Traffic switched to GREEN environment"
        
    - name: Monitor green environment
      run: |
        echo "Step 4: Monitoring GREEN environment for 60 seconds"
        sleep 60
        echo "âœ… GREEN environment is stable"
        
    - name: Mark blue as backup
      run: |
        echo "Step 5: Keeping BLUE environment as backup for rollback"
        echo "BLUE environment retained for quick rollback if needed"
        
  deploy-production-canary:
    name: Deploy to Production (Canary)
    runs-on: ubuntu-latest
    needs: [validate-release, build-release]
    if: inputs.environment == 'production' && inputs.deployment_strategy == 'canary'
    environment:
      name: production
      url: https://github.com/marticliment/UniGetUI/releases
      
    steps:
    - name: Download deployment artifacts
      uses: actions/download-artifact@v4
      with:
        name: deployment-package-${{ needs.validate-release.outputs.version }}
        path: ./deploy
        
    - name: Deploy canary (10% traffic)
      run: |
        echo "Step 1: Deploying CANARY with 10% traffic"
        echo "Version: ${{ needs.validate-release.outputs.version }}"
        # Deploy canary version to subset of servers
        
    - name: Monitor canary metrics
      run: |
        echo "Step 2: Monitoring CANARY metrics for 5 minutes"
        sleep 300  # 5 minutes
        echo "âœ… Canary metrics are healthy"
        
    - name: Increase to 25% traffic
      run: |
        echo "Step 3: Increasing CANARY traffic to 25%"
        sleep 180  # 3 minutes
        
    - name: Increase to 50% traffic
      run: |
        echo "Step 4: Increasing CANARY traffic to 50%"
        sleep 180  # 3 minutes
        
    - name: Full rollout (100% traffic)
      run: |
        echo "Step 5: Rolling out to 100% traffic"
        echo "âœ… Full deployment complete"
        
  generate-release-notes:
    name: Generate Release Notes
    runs-on: ubuntu-latest
    needs: [validate-release, build-release]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        ref: ${{ inputs.release_tag || github.ref }}
        fetch-depth: 0
        
    - name: Generate release notes
      id: release_notes
      run: |
        # Get the previous release tag
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        if [ -n "$PREVIOUS_TAG" ]; then
          echo "Generating release notes from $PREVIOUS_TAG to ${{ needs.validate-release.outputs.version }}"
          
          cat > release-notes.md << EOF
        # Release Notes - v${{ needs.validate-release.outputs.version }}
        
        ## Changes
        
        $(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
        
        ## Contributors
        
        $(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"%an" --no-merges | sort -u)
        
        ## Installation
        
        Download the latest version from the [releases page](https://github.com/marticliment/UniGetUI/releases).
        
        ## Checksums
        
        See checksums.txt in the release artifacts.
        EOF
        else
          echo "No previous tag found, generating initial release notes"
          echo "# Release Notes - v${{ needs.validate-release.outputs.version }}" > release-notes.md
        fi
        
    - name: Upload release notes
      uses: actions/upload-artifact@v4
      with:
        name: release-notes-${{ needs.validate-release.outputs.version }}
        path: release-notes.md
        
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [validate-release, build-release, deploy-staging, deploy-production-direct, deploy-production-blue-green, deploy-production-canary, generate-release-notes]
    if: always()
    
    steps:
    - name: Generate deployment summary
      run: |
        echo "## Deployment Summary ðŸš€" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Release Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Version:** ${{ needs.validate-release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Pre-release:** ${{ needs.validate-release.outputs.is_prerelease }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment:** ${{ inputs.environment || 'auto' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Strategy:** ${{ inputs.deployment_strategy || 'direct' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Job Status" >> $GITHUB_STEP_SUMMARY
        echo "- Build Release: ${{ needs.build-release.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Deploy Staging: ${{ needs.deploy-staging.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
        echo "- Deploy Production (Direct): ${{ needs.deploy-production-direct.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
        echo "- Deploy Production (Blue-Green): ${{ needs.deploy-production-blue-green.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
        echo "- Deploy Production (Canary): ${{ needs.deploy-production-canary.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
        echo "- Generate Release Notes: ${{ needs.generate-release-notes.result }}" >> $GITHUB_STEP_SUMMARY
