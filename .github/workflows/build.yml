name: Build

on:
  push:
    branches: [ "main", "develop" ]
    paths:
      - '**.cs'
      - '**.csproj'
      - '**.sln'
      - 'scripts/**'
      - '.github/workflows/build.yml'
  pull_request:
    branches: [ "main", "develop" ]
    paths:
      - '**.cs'
      - '**.csproj'
      - '**.sln'
      - 'scripts/**'
      - '.github/workflows/build.yml'
  workflow_dispatch:
    inputs:
      configuration:
        description: 'Build configuration'
        required: false
        default: 'Release'
        type: choice
        options:
          - Release
          - Debug

env:
  DOTNET_VERSION: '8.0.x'
  BUILD_CONFIGURATION: ${{ inputs.configuration || 'Release' }}
  BUILD_PLATFORM: 'x64'

jobs:
  build:
    name: Build Application
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0
        
    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
          
    - name: Restore dependencies
      working-directory: src
      run: dotnet restore --verbosity minimal
      
    - name: Build solution
      working-directory: src
      run: dotnet build UniGetUI.sln --configuration ${{ env.BUILD_CONFIGURATION }} --no-restore --verbosity minimal
      
    - name: Publish application
      working-directory: src
      run: |
        dotnet publish UniGetUI/UniGetUI.csproj `
          /noLogo `
          /property:Configuration=${{ env.BUILD_CONFIGURATION }} `
          /property:Platform=${{ env.BUILD_PLATFORM }} `
          --verbosity minimal
          
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: unigetui-${{ env.BUILD_CONFIGURATION }}-${{ github.sha }}
        path: src/UniGetUI/bin/${{ env.BUILD_PLATFORM }}/${{ env.BUILD_CONFIGURATION }}/net8.0-windows10.0.26100.0/win-x64/publish/
        retention-days: 30
        
    - name: Generate build summary
      run: |
        echo "### Build Summary :rocket:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Configuration:** ${{ env.BUILD_CONFIGURATION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Platform:** ${{ env.BUILD_PLATFORM }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        
  build-status:
    name: Build Status Check
    runs-on: ubuntu-latest
    needs: build
    if: always()
    
    steps:
    - name: Check build status
      run: |
        if [ "${{ needs.build.result }}" == "success" ]; then
          echo "✅ Build completed successfully"
          exit 0
        else
          echo "❌ Build failed"
          exit 1
        fi
